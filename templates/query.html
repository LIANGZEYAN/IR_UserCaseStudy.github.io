<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Survey Query {{ query_position }}</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f2f2f2;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1000px;
      margin: auto;
      background-color: #fff;
      padding: 20px 40px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 5px;
      position: relative;
    }
    h1, h2, p {
      text-align: center;
      color: #333;
    }
    .progress {
      text-align: center;
      font-weight: bold;
      margin-bottom: 20px;
    }
    .grid-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-gap: 20px;
      margin-bottom: 20px;
    }
    .grid-item {
      border: 1px solid #ccc;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      background-color: #f9f9f9;
      transition: background-color 0.3s ease;
      border-radius: 4px;
    }
    .grid-item.selected {
      background-color: #a8d5e2;
    }
    .nav-btn, .pause-btn {
      display: inline-block;
      margin: 20px 10px 0;
      padding: 10px 20px;
      font-size: 16px;
      background-color: #4CAF50;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .nav-btn:hover, .pause-btn:hover {
      background-color: #45a049;
    }
    .pause-btn {
      position: absolute;
      top: 10px;
      right: 10px;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
    }
    .modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 600px;
      border-radius: 5px;
      text-align: center;
    }
    .modal-content input[type="range"] {
      width: 100%;
      margin-top: 20px;
    }
    .modal-content input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .modal-content button {
      margin-top: 15px;
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .modal-content button:hover {
      background-color: #45a049;
    }
    .modal-content label {
      font-size: 16px;
      display: block;
      margin-top: 10px;
    }
    #enlargeDoc {
      border: 1px solid #ccc;
      padding: 15px;
      margin-top: 10px;
      text-align: left;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      user-select: text !important;
    }
    .debug-panel {
      background-color: #f8f9fa;
      padding: 10px;
      margin-bottom: 20px;
      border: 1px solid #ddd;
      display: none;
    }
    .debug-btn {
      position: fixed;
      bottom: 10px;
      right: 10px;
      z-index: 1000;
      opacity: 0.5;
      background-color: #6c757d;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- 调试面板 -->
  <div class="debug-panel" id="debugInfo" style="display: none;">
    <h3>调试信息</h3>
    <p>Query Position: {{ query_position }}</p>
    <p>Query ID (Database): {{ query_id }}</p>
    <p>Query Content: {{ query_content }}</p>
    <p>Documents: {{ docs|length }} 个</p>
    <button onclick="document.getElementById('debugData').style.display = document.getElementById('debugData').style.display === 'none' ? 'block' : 'none';">
      显示/隐藏详细数据
    </button>
    <div id="debugData" style="display: none;">
      <pre>{{ docs|tojson }}</pre>
    </div>
  </div>

  <div class="container">
    <button class="pause-btn" onclick="pauseSurvey()">Pause</button>
    <div class="progress">Progress: Query {{ query_position }} of {{ total_queries }}</div>
    <br>
    <br>
    <p>Task: Please click on any documents that you judge to be relevant to the following query. When you click a document, a pop-up window will appear. In the pop-up, please select the passage of document text that supports your decision.</p>
    <h2>Query: {{ query_content }}</h2>
    
    <!-- 文档网格 -->
    <div class="grid-container">
      {% if docs and docs|length > 0 %}
        {% for doc in docs %}
          <div class="grid-item"
               data-docno="{{ doc.docno|string }}"
               data-fulltext="{{ doc.content|e if doc.content else '文档内容为空'|e }}"
               onclick="openEnlargeModal(this)">
            <p class="doc-content">{{ doc.content|truncate(500) if doc.content else '文档内容为空' }}</p>
          </div>
        {% endfor %}
      {% else %}
        <div style="grid-column: span 3; text-align: center; padding: 50px 0;">
          <p>未找到与此查询相关的文档。</p>
        </div>
      {% endif %}
    </div>

    <div style="text-align: center;">
      {% if query_position > 1 %}
      <button class="nav-btn" onclick="goBack()">Back</button>
      {% endif %}
      <button class="nav-btn" onclick="submitQuery()">Next</button>
    </div>
  </div>

  <!-- 机器人验证模态框 - 注意这里使用query_position -->
  {% if query_position == 1 %}
  <div id="botModal" class="modal">
    <div class="modal-content">
      <h2>Bot Verification</h2>
      <p id="botText"></p>
      <input type="range" id="botSlider" min="0" max="100" value="0">
      <label id="sliderValue">0</label>
      <button id="botVerify">Verify</button>
    </div>
  </div>
  {% endif %}

<!-- 注意力检查模态框和文档扩展模态框保持不变 -->

  <!-- 注意力检查模态框 -->
  <div id="attentionModal" class="modal">
    <div class="modal-content">
      <h2>Attention Check</h2>
      <p id="attentionQuestion"></p>
      <input type="text" id="attentionAnswer" placeholder="Your answer here...">
      <button id="attentionSubmit">Submit</button>
    </div>
  </div>

  <!-- 文档扩展模态框 -->
  <div id="enlargeModal" class="modal">
    <div class="modal-content">
      <h2>Document Passage Selection</h2>
      <h3 id="enlargeQuery">{{ query_content }}</h3>
      <div id="enlargeDoc"></div>
      <p>Select a portion of the text that supports why this document is relevant to the query.</p>
      <button onclick="submitPassageSelection()">Submit Selection</button>
      <button onclick="cancelPassageSelection()">Cancel</button>
    </div>
  </div>

  <!-- 调试按钮 -->
  <button onclick="document.getElementById('debugInfo').style.display = 'block';" 
          style="position: fixed; bottom: 10px; right: 10px; z-index: 1000; opacity: 0.5;">Debug</button>

  <script>
    // 更新全局变量，使用查询位置和ID
    let currentQid = {{ query_id }};  // 数据库中的真实查询ID
    let currentPosition = {{ query_position }};  // 查询位置（1, 2, 3...）
    let totalQueries = {{ total_queries }};  // 总查询数
    console.debug = function() {};
    console.debug("Current Position:", currentPosition, "Current Qid (DB):", currentQid);
    let userId = "{{ session['user_id'] }}";
    let lastEventTime = Date.now();
    let currentDocno = null;

    // 页面加载时恢复状态
    document.addEventListener("DOMContentLoaded", function() {
      console.debug("DOM loaded, restoring state...");
      try {
        let selectedDocs = JSON.parse(sessionStorage.getItem("selected_docs_qid_" + currentQid)) || [];
        let passageHighlights = JSON.parse(sessionStorage.getItem("passage_highlight_qid_" + currentQid)) || {};
        
        console.debug("Restoring selected docs:", selectedDocs);
        console.debug("Restoring highlights:", passageHighlights);
        
        document.querySelectorAll(".grid-item").forEach(item => {
          let docnoStr = item.getAttribute("data-docno");
          console.debug("Processing grid item with docno:", docnoStr);
          
          // 尝试将selectedDocs中的项转换为字符串以匹配
          let found = false;
          for (let i = 0; i < selectedDocs.length; i++) {
            if (String(selectedDocs[i]) === docnoStr) {
              found = true;
              break;
            }
          }
          
          if (found) {
            console.debug("Found selected doc:", docnoStr);
            item.classList.add("selected");
            if (passageHighlights[docnoStr]) {
              item.querySelector(".doc-content").innerHTML = passageHighlights[docnoStr];
            }
          }
        });
      } catch (e) {
        console.error("Error restoring state:", e);
      }
    });

    // 记录事件的函数
    function logEvent({
      docno = 0,
      eventType = "",
      startIndex = -1,
      endIndex = -1,
      passFlag = 0
    } = {}) {
      let now = Date.now();
      let duration = now - lastEventTime;
      lastEventTime = now;
      let payload = {
        userId: userId,
        qid: currentQid,
        docno: docno,
        eventType: eventType,
        startIndex: startIndex,
        endIndex: endIndex,
        duration: duration,
        passFlag: passFlag
      };
      console.debug("Logging Event:", payload);
      fetch('/api/log', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      })
      .then(response => response.json())
      .then(data => console.debug("Log response:", data))
      .catch(err => console.error("Log error:", err));
    }

    // 修改openEnlargeModal函数
    function openEnlargeModal(element) {
      let docnoStr = element.getAttribute('data-docno');
      let docno = docnoStr;
      
      console.debug("Processing document with docno:", docno);
      
      if (element.classList.contains('selected')) {
        // 如果文档已被选中，询问用户是取消选择还是重新选择文本
        if (confirm("This document is already selected. Do you want to cancel selection? Click 'OK' to cancel, or 'Cancel' to update your text selection.")) {
          // 用户选择取消选择
          element.classList.remove('selected');
          let selectedDocs = JSON.parse(sessionStorage.getItem("selected_docs_qid_" + currentQid)) || [];
          selectedDocs = selectedDocs.filter(n => String(n) !== String(docno));
          sessionStorage.setItem("selected_docs_qid_" + currentQid, JSON.stringify(selectedDocs));
          
          // 删除保存的文本高亮
          let passageHighlights = JSON.parse(sessionStorage.getItem("passage_highlight_qid_" + currentQid)) || {};
          delete passageHighlights[docno];
          sessionStorage.setItem("passage_highlight_qid_" + currentQid, JSON.stringify(passageHighlights));
          
          // 恢复原始文本
          let originalText = element.getAttribute('data-fulltext');
          element.querySelector(".doc-content").innerText = originalText.substring(0, 500);
          
          logEvent({ docno: docno, eventType: "UNSELECT" });
        } else {
          // 用户选择更新文本选择
          currentDocno = docno;
          let fullText = element.getAttribute('data-fulltext');
          logEvent({ docno: docno, eventType: "UPDATE_SELECTION" });
          document.getElementById("enlargeDoc").innerText = fullText;
          document.getElementById("enlargeModal").style.display = "block";
        }
      } else {
        // 文档未被选中，打开文档扩展模态框
        currentDocno = docno;
        let fullText = element.getAttribute('data-fulltext');
        logEvent({ docno: docno, eventType: "OPEN_DOC" });
        document.getElementById("enlargeDoc").innerText = fullText;
        document.getElementById("enlargeModal").style.display = "block";
      }
    }

    // 取消文档段落选择
    function cancelPassageSelection() {
      logEvent({ docno: currentDocno, eventType: "CANCEL_DOC" });
      document.getElementById("enlargeModal").style.display = "none";
    }

    // 提交文档段落选择
    function submitPassageSelection() {
      let enlargeDocElem = document.getElementById("enlargeDoc");
      let rawFullText = enlargeDocElem.innerText;
      let rawSelectedText = window.getSelection().toString();
      
      console.debug("Raw full text length:", rawFullText.length);
      console.debug("Raw selected text:", rawSelectedText);
      
      if (!rawSelectedText.trim()) {
        alert("Please select a portion of the text before submitting.");
        return;
      }
      
      // 为减少因换行空格差异导致匹配失败，统一处理空白
      function unifyWhitespace(str) {
        return str.replace(/\r/g, "").replace(/\s+/g, " ").trim();
      }
      
      let cleanFullText = unifyWhitespace(rawFullText);
      let cleanSelected = unifyWhitespace(rawSelectedText);
      
      console.debug("Clean full text length:", cleanFullText.length);
      console.debug("Clean selected text:", cleanSelected);
      
      let startIndex = cleanFullText.indexOf(cleanSelected);
      if (startIndex === -1) {
        alert("Could not find the selected text in the document. Try selecting again.");
        return;
      }
      
      let endIndex = startIndex + cleanSelected.length;
      logEvent({
        docno: currentDocno,
        eventType: "PASSAGE_SELECTION",
        startIndex: startIndex,
        endIndex: endIndex
      });
      
      // 保存状态到 sessionStorage
      let selectedDocs = JSON.parse(sessionStorage.getItem("selected_docs_qid_" + currentQid)) || [];
      if (!selectedDocs.includes(currentDocno)) {
        selectedDocs.push(currentDocno);
        sessionStorage.setItem("selected_docs_qid_" + currentQid, JSON.stringify(selectedDocs));
      }
      
      let highlighted = rawFullText.substring(0, startIndex)
                       + "<mark>" + rawFullText.substring(startIndex, endIndex) + "</mark>"
                       + rawFullText.substring(endIndex);
                       
      let passageHighlights = JSON.parse(sessionStorage.getItem("passage_highlight_qid_" + currentQid)) || {};
      passageHighlights[currentDocno] = highlighted;
      sessionStorage.setItem("passage_highlight_qid_" + currentQid, JSON.stringify(passageHighlights));
      
      let item = document.querySelector('.grid-item[data-docno="' + currentDocno + '"]');
      if (item) {
        item.classList.add('selected');
        item.querySelector(".doc-content").innerHTML = highlighted;
      }
      
      document.getElementById("enlargeModal").style.display = "none";
    }

    // 页面导航函数需要修改，使用查询位置
    function navigatePage(target) {
      logEvent({ eventType: "PAGE_NAV" });
      if (target === 'next') {
        window.location.href = currentPosition < totalQueries 
          ? "/query/" + (currentPosition + 1) 
          : "/thanks";
      } else {
        window.location.href = "/query/" + (currentPosition - 1);
      }
    }

    // Add these functions to implement non-blocking navigation

// Cache for storing fetched pages
const pageCache = {};

// Non-blocking navigation function
function navigatePageNonBlocking(target) {
  logEvent({ eventType: "PAGE_NAV" });
  
  // Determine target page URL
  let targetUrl;
  if (target === 'next') {
    targetUrl = currentPosition < totalQueries 
      ? "/query/" + (currentPosition + 1) 
      : "/thanks";
  } else {
    targetUrl = "/query/" + (currentPosition - 1);
  }
  
  // Show loading indicator
  showLoading();
  
  // Check if the page is already in cache
  if (pageCache[targetUrl]) {
    console.debug("Loading page from cache:", targetUrl);
    updatePageContent(pageCache[targetUrl]);
    hideLoading();
    return;
  }
  
  // Fetch the target page
  fetch(targetUrl)
    .then(response => response.text())
    .then(html => {
      // Cache the fetched page
      pageCache[targetUrl] = html;
      
      // Update page content
      updatePageContent(html);
      
      // Prefetch next page if appropriate
      if (target === 'next' && currentPosition + 1 < totalQueries) {
        prefetchNextPage(currentPosition + 2);
      }
    })
    .catch(error => {
      console.error("Navigation error:", error);
      // Fallback to traditional navigation
      window.location.href = targetUrl;
    })
    .finally(() => {
      hideLoading();
    });
}

// Update the page content without a full reload
function updatePageContent(html) {
  // Parse the HTML
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, 'text/html');
  
  // Extract important parts
  const newContainer = doc.querySelector('.container');
  const newTitle = doc.querySelector('title').textContent;
  
  // Update page URL for history (without reloading)
  const newUrl = new URL(window.location);
  if (newUrl.pathname.includes('/query/')) {
    newUrl.pathname = newUrl.pathname.replace(/\/query\/\d+/, '/query/' + (currentPosition + (target === 'next' ? 1 : -1)));
    window.history.pushState({}, newTitle, newUrl);
  }
  
  // Update the page content
  const currentContainer = document.querySelector('.container');
  currentContainer.innerHTML = newContainer.innerHTML;
  document.title = newTitle;
  
  // Update global variables from the new page
  updateGlobalVariables(doc);
  
  // Reattach event listeners
  reattachEventListeners();
  
  // Restore any saved state
  restoreState();
}

// Update global variables from the new page
function updateGlobalVariables(doc) {
  // Extract script content that contains the variables
  const scripts = doc.querySelectorAll('script');
  let scriptContent = '';
  scripts.forEach(script => {
    if (script.textContent.includes('currentQid') || 
        script.textContent.includes('currentPosition') || 
        script.textContent.includes('totalQueries')) {
      scriptContent += script.textContent;
    }
  });
  
  // Extract variable assignments using regex
  const qidMatch = scriptContent.match(/currentQid\s*=\s*(\d+)/);
  const posMatch = scriptContent.match(/currentPosition\s*=\s*(\d+)/);
  const totalMatch = scriptContent.match(/totalQueries\s*=\s*(\d+)/);
  
  // Update variables if found
  if (qidMatch) currentQid = parseInt(qidMatch[1]);
  if (posMatch) currentPosition = parseInt(posMatch[1]);
  if (totalMatch) totalQueries = parseInt(totalMatch[1]);
  
  console.debug("Updated variables - Position:", currentPosition, "QID:", currentQid, "Total:", totalQueries);
}

// Reattach event listeners after content update
function reattachEventListeners() {
  // Reattach grid item click listeners
  document.querySelectorAll(".grid-item").forEach(item => {
    item.addEventListener("click", function() {
      openEnlargeModal(this);
    });
  });
  
  // Reattach navigation button listeners
  const nextBtn = document.querySelector('.nav-btn:last-child');
  if (nextBtn) {
    nextBtn.addEventListener("click", submitQuery);
  }
  
  const backBtn = document.querySelector('.nav-btn:first-child');
  if (backBtn) {
    backBtn.addEventListener("click", goBack);
  }
  
  // Reattach pause button listener
  const pauseBtn = document.querySelector('.pause-btn');
  if (pauseBtn) {
    pauseBtn.addEventListener("click", pauseSurvey);
  }
  
  // Check for and initialize bot verification if needed
  if (currentPosition === 1 && !sessionStorage.getItem("botChecked")) {
    initBotVerification();
  }
}

// Initialize bot verification if on first page
function initBotVerification() {
  if (document.getElementById("botModal")) {
    let botThreshold = Math.floor(Math.random() * 99) + 1;
    document.getElementById("botText").innerText = "Please slide the slider to at least " + botThreshold + " to confirm you are human.";
    document.getElementById("botModal").style.display = "block";
    
    const botSlider = document.getElementById("botSlider");
    const sliderValueLabel = document.getElementById("sliderValue");
    
    if (botSlider && sliderValueLabel) {
      botSlider.addEventListener("input", function(){
        sliderValueLabel.textContent = botSlider.value;
      });
    }
    
    if (document.getElementById("botVerify")) {
      document.getElementById("botVerify").addEventListener("click", function(){
        if (parseInt(botSlider.value) >= botThreshold) {
          logEvent({ 
            eventType: "BOT_DETECTION", 
            passFlag: 1,
            duration: Date.now() - lastEventTime
          });
          sessionStorage.setItem("botChecked", "true");
          document.getElementById("botModal").style.display = "none";
          lastEventTime = Date.now();
        } else {
          alert("Please slide the slider further (at least to " + botThreshold + ") to verify you are human.");
        }
      });
    }
  }
}

// Show loading indicator
function showLoading() {
  // Create loading indicator if it doesn't exist
  if (!document.getElementById('loadingIndicator')) {
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loadingIndicator';
    loadingDiv.style.position = 'fixed';
    loadingDiv.style.top = '0';
    loadingDiv.style.left = '0';
    loadingDiv.style.width = '100%';
    loadingDiv.style.height = '100%';
    loadingDiv.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
    loadingDiv.style.display = 'flex';
    loadingDiv.style.justifyContent = 'center';
    loadingDiv.style.alignItems = 'center';
    loadingDiv.style.zIndex = '9999';
    
    const spinner = document.createElement('div');
    spinner.style.border = '5px solid #f3f3f3';
    spinner.style.borderTop = '5px solid #3498db';
    spinner.style.borderRadius = '50%';
    spinner.style.width = '50px';
    spinner.style.height = '50px';
    spinner.style.animation = 'spin 1s linear infinite';
    
    const style = document.createElement('style');
    style.textContent = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
    
    document.head.appendChild(style);
    loadingDiv.appendChild(spinner);
    document.body.appendChild(loadingDiv);
  } else {
    document.getElementById('loadingIndicator').style.display = 'flex';
  }
}

// Hide loading indicator
function hideLoading() {
  const loadingIndicator = document.getElementById('loadingIndicator');
  if (loadingIndicator) {
    loadingIndicator.style.display = 'none';
  }
}

// Prefetch the next page to speed up future navigation
function prefetchNextPage(position) {
  if (position <= totalQueries) {
    const nextUrl = "/query/" + position;
    if (!pageCache[nextUrl]) {
      console.debug("Prefetching next page:", nextUrl);
      fetch(nextUrl)
        .then(response => response.text())
        .then(html => {
          pageCache[nextUrl] = html;
          console.debug("Prefetched page cached:", nextUrl);
        })
        .catch(error => {
          console.error("Prefetch error:", error);
        });
    }
  }
}

// Update the existing navigation functions to use non-blocking navigation
function submitQuery() {
  navigatePageNonBlocking('next');
}

function goBack() {
  navigatePageNonBlocking('back');
}

// Start prefetching next page when page loads
document.addEventListener("DOMContentLoaded", function() {
  // Restore state as before
  try {
    let selectedDocs = JSON.parse(sessionStorage.getItem("selected_docs_qid_" + currentQid)) || [];
    let passageHighlights = JSON.parse(sessionStorage.getItem("passage_highlight_qid_" + currentQid)) || {};
    
    document.querySelectorAll(".grid-item").forEach(item => {
      let docnoStr = item.getAttribute("data-docno");
      
      // Check if this doc is in selected docs
      let found = false;
      for (let i = 0; i < selectedDocs.length; i++) {
        if (String(selectedDocs[i]) === docnoStr) {
          found = true;
          break;
        }
      }
      
      if (found) {
        item.classList.add("selected");
        if (passageHighlights[docnoStr]) {
          item.querySelector(".doc-content").innerHTML = passageHighlights[docnoStr];
        }
      }
    });
  } catch (e) {
    console.error("Error restoring state:", e);
  }
  
  // Prefetch next page
  if (currentPosition < totalQueries) {
    prefetchNextPage(currentPosition + 1);
  }
});
    // Add these functions to implement non-blocking navigation

    // Cache for storing fetched pages
    const pageCache = {};
    
    // Non-blocking navigation function
    function navigatePageNonBlocking(target) {
      logEvent({ eventType: "PAGE_NAV" });
      
      // Determine target page URL
      let targetUrl;
      if (target === 'next') {
        targetUrl = currentPosition < totalQueries 
          ? "/query/" + (currentPosition + 1) 
          : "/thanks";
      } else {
        targetUrl = "/query/" + (currentPosition - 1);
      }
      
      // Show loading indicator
      showLoading();
      
      // Check if the page is already in cache
      if (pageCache[targetUrl]) {
        console.debug("Loading page from cache:", targetUrl);
        updatePageContent(pageCache[targetUrl]);
        hideLoading();
        return;
      }
      
      // Fetch the target page
      fetch(targetUrl)
        .then(response => response.text())
        .then(html => {
          // Cache the fetched page
          pageCache[targetUrl] = html;
          
          // Update page content
          updatePageContent(html);
          
          // Prefetch next page if appropriate
          if (target === 'next' && currentPosition + 1 < totalQueries) {
            prefetchNextPage(currentPosition + 2);
          }
        })
        .catch(error => {
          console.error("Navigation error:", error);
          // Fallback to traditional navigation
          window.location.href = targetUrl;
        })
        .finally(() => {
          hideLoading();
        });
    }
    
    // Update the page content without a full reload
    function updatePageContent(html) {
      // Parse the HTML
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      
      // Extract important parts
      const newContainer = doc.querySelector('.container');
      const newTitle = doc.querySelector('title').textContent;
      
      // Update page URL for history (without reloading)
      const newUrl = new URL(window.location);
      if (newUrl.pathname.includes('/query/')) {
        newUrl.pathname = newUrl.pathname.replace(/\/query\/\d+/, '/query/' + (currentPosition + (target === 'next' ? 1 : -1)));
        window.history.pushState({}, newTitle, newUrl);
      }
      
      // Update the page content
      const currentContainer = document.querySelector('.container');
      currentContainer.innerHTML = newContainer.innerHTML;
      document.title = newTitle;
      
      // Update global variables from the new page
      updateGlobalVariables(doc);
      
      // Reattach event listeners
      reattachEventListeners();
      
      // Restore any saved state
      restoreState();
    }
    
    // Update global variables from the new page
    function updateGlobalVariables(doc) {
      // Extract script content that contains the variables
      const scripts = doc.querySelectorAll('script');
      let scriptContent = '';
      scripts.forEach(script => {
        if (script.textContent.includes('currentQid') || 
            script.textContent.includes('currentPosition') || 
            script.textContent.includes('totalQueries')) {
          scriptContent += script.textContent;
        }
      });
      
      // Extract variable assignments using regex
      const qidMatch = scriptContent.match(/currentQid\s*=\s*(\d+)/);
      const posMatch = scriptContent.match(/currentPosition\s*=\s*(\d+)/);
      const totalMatch = scriptContent.match(/totalQueries\s*=\s*(\d+)/);
      
      // Update variables if found
      if (qidMatch) currentQid = parseInt(qidMatch[1]);
      if (posMatch) currentPosition = parseInt(posMatch[1]);
      if (totalMatch) totalQueries = parseInt(totalMatch[1]);
      
      console.debug("Updated variables - Position:", currentPosition, "QID:", currentQid, "Total:", totalQueries);
    }
    
    // Reattach event listeners after content update
    function reattachEventListeners() {
      // Reattach grid item click listeners
      document.querySelectorAll(".grid-item").forEach(item => {
        item.addEventListener("click", function() {
          openEnlargeModal(this);
        });
      });
      
      // Reattach navigation button listeners
      const nextBtn = document.querySelector('.nav-btn:last-child');
      if (nextBtn) {
        nextBtn.addEventListener("click", submitQuery);
      }
      
      const backBtn = document.querySelector('.nav-btn:first-child');
      if (backBtn) {
        backBtn.addEventListener("click", goBack);
      }
      
      // Reattach pause button listener
      const pauseBtn = document.querySelector('.pause-btn');
      if (pauseBtn) {
        pauseBtn.addEventListener("click", pauseSurvey);
      }
      
      // Check for and initialize bot verification if needed
      if (currentPosition === 1 && !sessionStorage.getItem("botChecked")) {
        initBotVerification();
      }
    }
    
    // Initialize bot verification if on first page
    function initBotVerification() {
      if (document.getElementById("botModal")) {
        let botThreshold = Math.floor(Math.random() * 99) + 1;
        document.getElementById("botText").innerText = "Please slide the slider to at least " + botThreshold + " to confirm you are human.";
        document.getElementById("botModal").style.display = "block";
        
        const botSlider = document.getElementById("botSlider");
        const sliderValueLabel = document.getElementById("sliderValue");
        
        if (botSlider && sliderValueLabel) {
          botSlider.addEventListener("input", function(){
            sliderValueLabel.textContent = botSlider.value;
          });
        }
        
        if (document.getElementById("botVerify")) {
          document.getElementById("botVerify").addEventListener("click", function(){
            if (parseInt(botSlider.value) >= botThreshold) {
              logEvent({ 
                eventType: "BOT_DETECTION", 
                passFlag: 1,
                duration: Date.now() - lastEventTime
              });
              sessionStorage.setItem("botChecked", "true");
              document.getElementById("botModal").style.display = "none";
              lastEventTime = Date.now();
            } else {
              alert("Please slide the slider further (at least to " + botThreshold + ") to verify you are human.");
            }
          });
        }
      }
    }
    
    // Show loading indicator
    function showLoading() {
      // Create loading indicator if it doesn't exist
      if (!document.getElementById('loadingIndicator')) {
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loadingIndicator';
        loadingDiv.style.position = 'fixed';
        loadingDiv.style.top = '0';
        loadingDiv.style.left = '0';
        loadingDiv.style.width = '100%';
        loadingDiv.style.height = '100%';
        loadingDiv.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
        loadingDiv.style.display = 'flex';
        loadingDiv.style.justifyContent = 'center';
        loadingDiv.style.alignItems = 'center';
        loadingDiv.style.zIndex = '9999';
        
        const spinner = document.createElement('div');
        spinner.style.border = '5px solid #f3f3f3';
        spinner.style.borderTop = '5px solid #3498db';
        spinner.style.borderRadius = '50%';
        spinner.style.width = '50px';
        spinner.style.height = '50px';
        spinner.style.animation = 'spin 1s linear infinite';
        
        const style = document.createElement('style');
        style.textContent = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
        
        document.head.appendChild(style);
        loadingDiv.appendChild(spinner);
        document.body.appendChild(loadingDiv);
      } else {
        document.getElementById('loadingIndicator').style.display = 'flex';
      }
    }
    
    // Hide loading indicator
    function hideLoading() {
      const loadingIndicator = document.getElementById('loadingIndicator');
      if (loadingIndicator) {
        loadingIndicator.style.display = 'none';
      }
    }
    
    // Prefetch the next page to speed up future navigation
    function prefetchNextPage(position) {
      if (position <= totalQueries) {
        const nextUrl = "/query/" + position;
        if (!pageCache[nextUrl]) {
          console.debug("Prefetching next page:", nextUrl);
          fetch(nextUrl)
            .then(response => response.text())
            .then(html => {
              pageCache[nextUrl] = html;
              console.debug("Prefetched page cached:", nextUrl);
            })
            .catch(error => {
              console.error("Prefetch error:", error);
            });
        }
      }
    }
    
    // Update the existing navigation functions to use non-blocking navigation
    function submitQuery() {
      navigatePageNonBlocking('next');
    }
    
    function goBack() {
      navigatePageNonBlocking('back');
    }
    
    // Start prefetching next page when page loads
    document.addEventListener("DOMContentLoaded", function() {
      // Restore state as before
      try {
        let selectedDocs = JSON.parse(sessionStorage.getItem("selected_docs_qid_" + currentQid)) || [];
        let passageHighlights = JSON.parse(sessionStorage.getItem("passage_highlight_qid_" + currentQid)) || {};
        
        document.querySelectorAll(".grid-item").forEach(item => {
          let docnoStr = item.getAttribute("data-docno");
          
          // Check if this doc is in selected docs
          let found = false;
          for (let i = 0; i < selectedDocs.length; i++) {
            if (String(selectedDocs[i]) === docnoStr) {
              found = true;
              break;
            }
          }
          
          if (found) {
            item.classList.add("selected");
            if (passageHighlights[docnoStr]) {
              item.querySelector(".doc-content").innerHTML = passageHighlights[docnoStr];
            }
          }
        });
      } catch (e) {
        console.error("Error restoring state:", e);
      }
      
      // Prefetch next page
      if (currentPosition < totalQueries) {
        prefetchNextPage(currentPosition + 1);
      }
    });
    
    function pauseSurvey() {
      logEvent({ eventType: "PAGE_NAV" });
      window.location.href = "/pause?query=" + currentPosition;
    }

    // Bot检测 - 使用查询位置和首次访问标志
    console.debug("Checking bot detection, query position =", currentPosition);
    {% if query_position == 1 %}
      console.debug("Bot detection should be active");
      
      // 如果是首次访问，确保重置botChecked
      {% if is_first_visit %}
        console.debug("First visit to this query, resetting bot verification");
        sessionStorage.removeItem("botChecked");
      {% endif %}
      
      let botThreshold = Math.floor(Math.random() * 99) + 1;
      console.debug("Bot threshold set to:", botThreshold);
      
      // 确保元素存在后再操作
      if (document.getElementById("botText") && document.getElementById("botModal")) {
        document.getElementById("botText").innerText = "Please slide the slider to at least " + botThreshold + " to confirm you are human.";
        
        // 检查会话存储中的验证状态
        if (sessionStorage.getItem("botChecked") === "true") {
          console.debug("User already verified, hiding bot modal");
          document.getElementById("botModal").style.display = "none";
          lastEventTime = Date.now();
        } else {
          console.debug("User not verified, showing bot modal");
          document.getElementById("botModal").style.display = "block";
        }
        
        let botDetectionStart = Date.now();
        const botSlider = document.getElementById("botSlider");
        const sliderValueLabel = document.getElementById("sliderValue");
        
        if (botSlider && sliderValueLabel) {
          botSlider.addEventListener("input", function(){
            sliderValueLabel.textContent = botSlider.value;
          });
        }
        
        if (document.getElementById("botVerify")) {
          document.getElementById("botVerify").addEventListener("click", function(){
            if (parseInt(botSlider.value) >= botThreshold) {
              let botDetectionDuration = Date.now() - botDetectionStart;
              logEvent({ 
                eventType: "BOT_DETECTION", 
                passFlag: 1,
                duration: botDetectionDuration
              });
              sessionStorage.setItem("botChecked", "true");
              document.getElementById("botModal").style.display = "none";
              lastEventTime = Date.now();
            } else {
              alert("Please slide the slider further (at least to " + botThreshold + ") to verify you are human.");
            }
          });
        }
      } else {
        console.error("Bot detection elements not found in DOM");
      }
    {% else %}
      console.debug("Bot detection not active for this query position");
    {% endif %}
  
    // 注意力检查
    const attentionChecks = [
      { question: "Please answer: What is your favorite color? (Answer 'Navy')", correctAnswer: "Navy" },
      { question: "Type the word 'Banana' exactly as shown.", correctAnswer: "Banana" },
      { question: "Please type 'Elephant' if you read carefully.", correctAnswer: "Elephant" },
      { question: "What is 2+2? (Answer '4')", correctAnswer: "4" },
      { question: "Answer 'Blue' to: What color do you see?", correctAnswer: "Blue" },
      { question: "Enter the secret word 'Sunshine'.", correctAnswer: "Sunshine" },
      { question: "Type 'Correct' to confirm you read the instructions.", correctAnswer: "Correct" },
      { question: "Answer 'Yes, I have read it'.", correctAnswer: "Yes, I have read it" },
      { question: "If you read instructions, type 'Confirmed'.", correctAnswer: "Confirmed" },
      { question: "If paying attention, answer 'Verified'.", correctAnswer: "Verified" }
    ];
    
    function showAttentionCheck() {
      let randomIndex = Math.floor(Math.random() * attentionChecks.length);
      let selectedCheck = attentionChecks[randomIndex];
      document.getElementById("attentionQuestion").innerText = selectedCheck.question;
      document.getElementById("attentionModal").setAttribute("data-question", selectedCheck.question);
      document.getElementById("attentionModal").setAttribute("data-correct", selectedCheck.correctAnswer);
      document.getElementById("attentionModal").style.display = "block";
    }
    
    setTimeout(function(){
      showAttentionCheck();
    }, 480000);
    
    document.getElementById("attentionSubmit").addEventListener("click", function(){
      let userAnswer = document.getElementById("attentionAnswer").value.trim();
      let correctAnswer = document.getElementById("attentionModal").getAttribute("data-correct");
      if (userAnswer === correctAnswer) {
        logEvent({ eventType: "ATTENTION_CHECK", passFlag: 1 });
        document.getElementById("attentionModal").style.display = "none";
        lastEventTime = Date.now();
      } else {
        alert("Your answer is incorrect. Please read carefully.");
        logEvent({ eventType: "ATTENTION_CHECK", passFlag: 0 });
      }
    });
  </script>
</body>
</html>
